<div class="profile-container">
  @if (isLoading()) {
  <div class="loading-spinner">
    <mat-icon class="spin">refresh</mat-icon>
    <p>Loading profile...</p>
  </div>
  } @else if (user(); as u) {

  <!-- PROFILE HEADER -->
  <mat-card class="profile-header">
    <div class="profile-info">
      <div class="avatar-section">
        @if (u.avatarUrl) {
        <img [src]="u.avatarUrl" [alt]="u.username" class="avatar">
        } @else {
        <div class="avatar-placeholder">
          <mat-icon>person</mat-icon>
        </div>
        }
      </div>

      <div class="user-details">
        <h1>{{ u.username }}</h1>
        <!-- ✅ FOLLOW STATS AS BUTTONS -->
        <mat-chip-set class="stats">
          <mat-chip class="stat">
            <strong>{{ blogsCount() }}</strong> Blogs
          </mat-chip>

          <button mat-chip class="stat clickable" (click)="openFollowers()">
            <strong>{{ followersCount() }}</strong> Followers
          </button>

          <button mat-chip class="stat clickable" (click)="openFollowing()">
            <strong>{{ followingCount() }}</strong> Following
          </button>
        </mat-chip-set>
      </div>
    </div>

    <!-- ✅ TOP RIGHT ACTIONS -->
    <div class="profile-actions">
      @if (isOwnProfile()) {
      <!--     -->
      } @else {
      <button mat-raised-button [color]="isFollowing() ? 'accent' : 'primary'" (click)="toggleFollow()">
        <mat-icon>
          {{ isFollowing() ? 'person_remove' : 'person_add' }}
        </mat-icon>
        {{ isFollowing() ? 'Unfollow' : 'Follow' }}
      </button>

      <!-- ✅ REPORT BUTTON TOP RIGHT -->
      <button mat-icon-button class="report-btn"
        [matTooltip]="hasAlreadyReported() ? 'Already reported' : 'Report user'" [disabled]="hasAlreadyReported()"
        (click)="openReportDialog()">
        <mat-icon>{{ hasAlreadyReported() ? 'task_alt' : 'outlined_flag' }}</mat-icon>
      </button>

      }
    </div>
  </mat-card>

  <!-- BLOGS SECTION -->
  <section class="blogs-section">
    <h2>Blogs ({{ blogsCount() }})</h2>

    @if (hasNoBlogs()) {
    <div class="no-blogs">
      <mat-icon>article</mat-icon>
      <p>No blogs yet</p>
    </div>
    } @else {
    <div class="blogs-grid" infiniteList (loadMore)="loadMoreBlogs()">
      @for (blog of blogs(); track blog.id) {
      <mat-card class="blog-card" (click)="viewBlog(blog.id)">
        @if (hasMedia(blog)) {
        <div class="media-container">
          @if (isBlogVideo(blog)) {
          <video [src]="getBlogMedia(blog)[0]" class="blog-media"></video>
          } @else {
          <img [src]="getBlogMedia(blog)[0]" class="blog-media">
          }
        </div>
        }

        <mat-card-content>
          <h3>{{ blog.title || 'Untitled' }}</h3>
          <p>{{ (blog.content || '').substring(0, 100) }}...</p>
        </mat-card-content>
      </mat-card>
      }
    </div>
    }
  </section>

  <!-- ✅ FOLLOWERS LIST DIALOG -->
  @if (showFollowersDialog()) {
  <div class="dialog-overlay" (click)="closeFollowers()">
    <mat-card class="list-dialog" (click)="$event.stopPropagation()">
      <mat-card-title>
        Followers ({{ followersCount() }})
        <span class="close-btn" mat-icon-button (click)="closeFollowers()">
          <mat-icon>close</mat-icon>
        </span>
      </mat-card-title>
      <mat-card-content>
        @if (followers().length === 0) {
        <p class="text-muted">No followers yet</p>
        } @else {
        @for (follower of followers(); track follower.id) {
        <mat-chip class="user-chip" (click)="viewUserProfile(follower.id); closeFollowers()">
          @if (follower.avatarUrl) {
          <img [src]="follower.avatarUrl" class="chip-avatar" matChipAvatar>
          }
          {{ follower.username }}
          <mat-icon matChipTrailingIcon>chevron_right</mat-icon>
        </mat-chip>
        }
        }
      </mat-card-content>
    </mat-card>
  </div>
  }

  <!-- ✅ FOLLOWING LIST DIALOG -->
  @if (showFollowingDialog()) {
  <div class="dialog-overlay" (click)="closeFollowing()">
    <mat-card class="list-dialog" (click)="$event.stopPropagation()">
      <mat-card-title>
        Following ({{ followingCount() }})
        <span class="close-btn" mat-icon-button (click)="closeFollowing()">
          <mat-icon>close</mat-icon>
        </span>
      </mat-card-title>
      <mat-card-content>
        @if (following().length === 0) {
        <p class="text-muted">Not following anyone</p>
        } @else {
        @for (user of following(); track user.id) {
        <mat-chip class="user-chip" (click)="viewUserProfile(user.id); closeFollowing()">
          @if (user.avatarUrl) {
          <img [src]="user.avatarUrl" class="chip-avatar" matChipAvatar>
          }
          {{ user.username }}
          <mat-icon matChipTrailingIcon>chevron_right</mat-icon>
        </mat-chip>
        }
        }
      </mat-card-content>
    </mat-card>
  </div>
  }

  }
</div>