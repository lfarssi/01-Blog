<div class="profile-container">
  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-icon class="spin">refresh</mat-icon>
      <p>Loading profile...</p>
    </div>
  } @else if (user(); as u) {
    
    <!-- Profile Header -->
    <mat-card class="profile-header">
      <div class="profile-info">
        <div class="avatar-section">
          @if (u.avatarUrl) {
            <img [src]="u.avatarUrl" [alt]="u.username" class="avatar">
          } @else {
            <div class="avatar-placeholder">
              <mat-icon>person</mat-icon>
            </div>
          }
        </div>

        <div class="user-details">
          <h1>{{ u.username }}</h1>

          @if (u.bio) {
            <p class="bio">{{ u.bio }}</p>
          }

          <mat-chip-set class="stats">
            <mat-chip class="stat"><strong>{{ blogsCount() }}</strong> Blogs</mat-chip>
            <mat-chip class="stat"><strong>{{ followersCount() }}</strong> Followers</mat-chip>
            <mat-chip class="stat"><strong>{{ followingCount() }}</strong> Following</mat-chip>
          </mat-chip-set>
        </div>
      </div>

      <div class="profile-actions">
        @if (isOwnProfile()) {
          <button mat-raised-button color="primary" (click)="editProfile()">
            <mat-icon>edit</mat-icon> Edit Profile
          </button>
        } @else {
          <button
            mat-raised-button
            [color]="isFollowing() ? 'accent' : 'primary'"
            (click)="toggleFollow()">
            <mat-icon>{{ isFollowing() ? 'person_remove' : 'person_add' }}</mat-icon>
            {{ isFollowing() ? 'Unfollow' : 'Follow' }} {{ u.username }}
          </button>

          <button
            mat-icon-button
            matTooltip="{{ hasAlreadyReported() ? 'Already reported' : 'Report user' }}"
            (click)="openReportDialog()"
            [disabled]="hasAlreadyReported()"
            class="report-btn">
            <mat-icon>{{ hasAlreadyReported() ? 'flag' : 'outlined_flag' }}</mat-icon>
          </button>
        }
      </div>
    </mat-card>

    <!-- Blogs Section -->
    <section class="blogs-section">
      <h2>Blogs ({{ blogsCount() || 0}})</h2>

      @if (hasNoBlogs()) {
        <div class="no-blogs">
          <mat-icon>article</mat-icon>
          <p>No blogs yet</p>
        </div>
      } @else {
        <!-- ✅ FIXED: Safe iterable check -->
        @if (blogs() && blogs().length > 0) {
          <div class="blogs-grid">
            @for (blog of blogs(); track $index; let i = $index) {
              <mat-card class="blog-card" (click)="viewBlog(blog.id)">
                <!-- ✅ Media with BlogDetail logic -->
                @if (hasMedia(blog)) {
                  <div class="media-container">
                    @if (isBlogVideo(blog)) {
                      <video [src]="getBlogMedia(blog)[0]" class="blog-media" preload="metadata"></video>
                      <div class="video-overlay">
                        <mat-icon>play_circle</mat-icon>
                      </div>
                    } @else {
                      <img [src]="getBlogMedia(blog)[0]" class="blog-media" [alt]="blog.title">
                    }
                  </div>
                }

                <mat-card-content>
                  <h3 class="blog-title">{{ blog.title || 'Untitled' }}</h3>
                  <p class="blog-description">{{ (blog.content || '').substring(0, 100) }}...</p>

                  <div class="blog-stats">
                    <span class="stat">
                      <mat-icon [class.liked]="blog.isLikedByCurrentUser">
                        {{ blog.isLikedByCurrentUser ? 'favorite' : 'favorite_border' }}
                      </mat-icon>
                      {{ blog.likeCount || 0 }}
                    </span>

                    <span class="stat">
                      <mat-icon>comment</mat-icon>
                      {{ blog.commentCount || 0 }}
                    </span>

                    <span class="timestamp">
                      {{ blog.createdAt | date: 'MMM d, y' }}
                    </span>
                  </div>
                </mat-card-content>
              </mat-card>
            }
          </div>
        }
      }
    </section>

    <!-- Report Dialog -->
    @if (showReportDialog()) {
      <div class="report-dialog-overlay" (click)="closeReportDialog()">
        <mat-card class="report-dialog" (click)="$event.stopPropagation()">
          <mat-card-title>Report {{ u.username }}</mat-card-title>
          <mat-card-content>
            <textarea
              rows="4"
              class="report-textarea"
              placeholder="Describe the issue..."
              [value]="reportReason()"
              (input)="reportReason.set($any($event.target).value)">
            </textarea>
          </mat-card-content>
          <mat-card-actions align="end">
            <button mat-button (click)="closeReportDialog()">Cancel</button>
            <button
              mat-raised-button
              color="warn"
              [disabled]="!reportReason().trim()"
              (click)="submitReport()">
              Submit Report
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    }
  } @else {
    <div class="error-state">
      <mat-icon>error_outline</mat-icon>
      <h2>User not found</h2>
      <p>The profile you are looking for does not exist.</p>
    </div>
  }
</div>
