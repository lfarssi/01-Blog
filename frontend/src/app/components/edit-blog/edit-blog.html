<div class="edit-blog">

  <!-- Loading -->
  @if (loading()) {
    <div class="state state--loading">
      <mat-spinner diameter="56"></mat-spinner>
      <p>Loading blog…</p>
    </div>
  } @else if (blog()) {

    <!-- HERO -->
    <header class="hero">
      <div class="hero__left">
        <div class="hero__icon" aria-hidden="true">
          <mat-icon>edit_note</mat-icon>
        </div>

        <div class="hero__text">
          <h1>Edit blog</h1>
          <p class="hero__subtitle">
            Update title/content and manage up to <strong>4</strong> media items.
          </p>
        </div>
      </div>

      <div class="hero__right">
        <div class="pill">
          <mat-icon>collections</mat-icon>
          <span>{{ media().length }}/4 media</span>
        </div>

        <div class="pill pill--soft">
          <mat-icon>badge</mat-icon>
          <span>ID: {{ blog()?.id }}</span>
        </div>
      </div>
    </header>

    <!-- Alerts -->
    @if (successMsg()) {
      <div class="notice notice--success" role="status">
        <mat-icon>check_circle</mat-icon>
        <span class="notice__text">{{ successMsg() }}</span>
        <button
          type="button"
          class="notice__close"
          (click)="successMsg.set(null)"
          aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    }

    @if (errorMsg()) {
      <div class="notice notice--error" role="alert">
        <mat-icon>error</mat-icon>
        <span class="notice__text">{{ errorMsg() }}</span>
        <button
          type="button"
          class="notice__close"
          (click)="errorMsg.set(null)"
          aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    }

    <!-- FORM -->
    <form id="editor-form" class="panel" [formGroup]="form" (ngSubmit)="submit()">
      <div class="panel__head">
        <div class="panel__title">
          <mat-icon>description</mat-icon>
          <div>
            <h2>Post details</h2>
            <p>Make sure the title and content are meaningful (not only spaces).</p>
          </div>
        </div>

        <div class="panel__meta">
          <div class="chip">
            <mat-icon>schedule</mat-icon>
            <span>Saved on update</span>
          </div>
        </div>
      </div>

      <div class="panel__body">
        <div class="fields">
          <!-- Title -->
          <div class="field">
            <label class="label" for="title">Title</label>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Blog title</mat-label>
              <input id="title" matInput formControlName="title" maxlength="120" cdkFocusInitial />
              <mat-hint>Minimum 5 characters</mat-hint>
              @if (f.title.touched && f.title.invalid) {
                <mat-error>Title required (min 5 characters)</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Content -->
          <div class="field">
            <label class="label" for="content">Content</label>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Content</mat-label>
              <textarea id="content" matInput maxlength="10000" rows="10" formControlName="content"></textarea>
              <mat-hint>Minimum 20 characters</mat-hint>
              @if (f.content.touched && f.content.invalid) {
                <mat-error>Content required (min 20 characters)</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      </div>
    </form>

    <!-- MEDIA PANEL -->
    <section class="panel">
      <div class="panel__head">
        <div class="panel__title">
          <mat-icon>photo_library</mat-icon>
          <div>
            <h2>Media</h2>
            <p>Click “Choose files” to add new items. Remove any item instantly.</p>
          </div>
        </div>

        <div class="panel__meta">
          <div class="chip">
            <mat-icon>layers</mat-icon>
            <span>{{ 4 - media().length }} slots left</span>
          </div>
        </div>
      </div>

      <div class="panel__body">
        <!-- Media Grid -->
        <div class="media-grid">
          @for (item of media(); track item.url; let i = $index) {
            <article class="media-tile">
              <div class="media-tile__preview">
                @if (isVideo(item.url)) {
                  <video [src]="item.url" muted playsinline preload="metadata"></video>
                  <div class="media-tile__badge">
                    <mat-icon>play_arrow</mat-icon>
                    <span>Video</span>
                  </div>
                } @else {
                  <img [src]="item.url" alt="Media preview" />
                }

                <!-- IMPORTANT: keep media-remove-btn -->
                <button
                  mat-icon-button
                  type="button"
                  class="media-remove-btn"
                  (click)="removeMedia(i)"
                  aria-label="Remove media">
                  <mat-icon>close</mat-icon>
                </button>

                <div class="media-tile__footer">
                  <span>Media {{ i + 1 }}</span>
                  @if (item.isNew) {
                    <span class="tag tag--new">New</span>
                  } @else {
                    <span class="tag">Existing</span>
                  }
                </div>
              </div>
            </article>
          }

          <!-- Empty placeholders -->
          @for (_ of [].constructor(4 - media().length); track $index) {
            <article class="media-empty" aria-hidden="true">
              <div class="media-empty__box">
                <mat-icon>add</mat-icon>
                <span>Empty slot</span>
              </div>
            </article>
          }
        </div>

        <!-- Upload -->
        <div class="upload">
          <input
            #fileInput
            type="file"
            class="upload__input"
            accept="image/*,video/*"
            multiple
            (change)="onNewFilesSelected($event)" />

          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="media().length >= 4 || isSaving()"
            (click)="fileInput.click()">
            <mat-icon>add</mat-icon>
            Choose files
          </button>

          <div class="upload__hint">
            Max 4 items • images/videos only • best under 10MB each
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS -->
    <footer class="actions">
      <button mat-stroked-button type="button" (click)="cancel()" [disabled]="isSaving()">
        <mat-icon>close</mat-icon>
        Cancel
      </button>

      <div class="actions__right">
        <button mat-flat-button color="warn" type="button" (click)="deleteBlog()" [disabled]="isSaving()">
          <mat-icon>delete</mat-icon>
          Delete
        </button>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          form="editor-form"
          [disabled]="form.invalid || isSaving() || media().length > 4">
          <mat-icon>save</mat-icon>
          @if (isSaving()) { Saving… } @else { Update }
        </button>
      </div>
    </footer>
  }
</div>
