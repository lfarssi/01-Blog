<div class="create-blog">
  <div class="shell">

    <!-- Header -->
    <header class="hero">
      <div class="hero__icon" aria-hidden="true">
        <mat-icon>edit_square</mat-icon>
      </div>

      <div class="hero__text">
        <h1>Create new blog</h1>
        <p>Write your post and optionally attach up to 4 images/videos.</p>
      </div>

      <div class="hero__meta">
        <div class="count">
          <span class="count__num">{{ selectedFiles().length }}</span>
          <span class="count__den">/ 4</span>
        </div>
      </div>
    </header>

    <!-- Alerts -->
    @if (successMsg()) {
      <div class="notice notice--success" role="status">
        <mat-icon>check_circle</mat-icon>
        <div class="notice__text">{{ successMsg() }}</div>
      </div>
    }

    @if (errorMsg()) {
      <div class="notice notice--error" role="alert">
        <mat-icon>error</mat-icon>
        <div class="notice__text">{{ errorMsg() }}</div>
      </div>
    }

    <!-- Form -->
    <form class="form" [formGroup]="form" (ngSubmit)="submit()">
      <!-- Title -->
      <div class="field">
        <label class="field__label" for="title">Title</label>
        <div class="field__control">
          <mat-icon class="field__icon">title</mat-icon>
          <input
            id="title"
            class="field__input"
            type="text"
            maxlength="120"
            formControlName="title"
            placeholder="A clear, catchy title…" />
        </div>

        @if (f.title.touched && f.title.invalid) {
          <div class="field__error">
            <mat-icon>error_outline</mat-icon>
            <span>Title must be at least 5 characters.</span>
          </div>
        }
      </div>

      <!-- Content -->
      <div class="field">
        <label class="field__label" for="content">Content</label>
        <div class="field__control field__control--textarea">
          <mat-icon class="field__icon">notes</mat-icon>
          <textarea
            id="content"
            class="field__input"
            rows="7"
            maxlength="10000"
            formControlName="content"
            placeholder="Share your learning journey…"></textarea>
        </div>

        @if (f.content.touched && f.content.invalid) {
          <div class="field__error">
            <mat-icon>error_outline</mat-icon>
            <span>Content must be at least 20 characters.</span>
          </div>
        }
      </div>

      <!-- Upload -->
      <section class="upload">
        <div class="upload__head">
          <div class="upload__title">
            <mat-icon>collections</mat-icon>
            <span>Media</span>
            <small>(optional)</small>
          </div>

          <div class="upload__hint">
            JPG/PNG/GIF/MP4/MOV • max 10MB each
          </div>
        </div>

        <!-- Dropzone -->
        <div
          class="dropzone"
          [class.dropzone--over]="dragOver()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
          tabindex="0"
          (keydown.enter)="fileInput.click()"
          (keydown.space)="fileInput.click()"
          role="button"
          aria-label="Upload media">

          <input
            #fileInput
            class="dropzone__input"
            type="file"
            accept="image/*,video/*"
            multiple
            (change)="onFilesSelected($event)" />

          <div class="dropzone__content">
            <div class="dropzone__badge">
              <mat-icon>{{ dragOver() ? 'cloud_download' : 'cloud_upload' }}</mat-icon>
            </div>

            @if (!dragOver()) {
              <div class="dropzone__text">
                <strong>Drop files here</strong>
                <span>or click to browse</span>
              </div>
            } @else {
              <div class="dropzone__text">
                <strong>Release to upload</strong>
                <span>We'll preview instantly</span>
              </div>
            }
          </div>
        </div>

        <!-- Previews -->
        @if (selectedFiles().length > 0) {
          <div class="grid">
            @for (file of selectedFiles(); track file.name + file.size; let i = $index) {
              <article class="media">
                <div class="media__preview">
                  @if (isVideoFile(file)) {
                    <video
                      [src]="getPreviewUrl(file)"
                      muted
                      playsinline
                      preload="metadata">
                    </video>

                    <div class="media__chip">
                      <mat-icon>play_arrow</mat-icon>
                      <span>Video</span>
                    </div>
                  } @else {
                    <img [src]="getPreviewUrl(file)" [alt]="file.name" />
                  }

                  <button
                    type="button"
                    class="media__remove"
                    (click)="removeFile(file); $event.stopPropagation()"
                    aria-label="Remove file">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>

                <footer class="media__meta">
                  <div class="media__name" [title]="file.name">{{ file.name }}</div>
                  <div class="media__size">{{ formatFileSize(file.size) }}</div>
                </footer>
              </article>
            }
          </div>
        }

        @if (selectedFiles().length === 4) {
          <div class="cap">
            <mat-icon>verified</mat-icon>
            <span>Maximum 4 files added</span>
          </div>
        }
      </section>

      <!-- Progress -->
      @if (loading()) {
        <div class="bar" aria-label="Uploading">
          <div class="bar__fill"></div>
        </div>
      }

      <!-- Actions -->
      <div class="actions">
        <button
          type="submit"
          class="cta"
          [disabled]="disabled()"
          [class.cta--loading]="loading()">

          @if (loading()) {
            <span class="cta__spinner" aria-hidden="true"></span>
            <span>Publishing…</span>
          } @else {
            <mat-icon>send</mat-icon>
            <span>
              @if (selectedFiles().length > 0) {
                Create blog + {{ selectedFiles().length }} media
              } @else {
                Create blog post
              }
            </span>
          }
        </button>

        <div class="footnote">
          <mat-icon>info</mat-icon>
          <span>Title and content are required.</span>
        </div>
      </div>
    </form>
  </div>
</div>
