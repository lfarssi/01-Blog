<div class="container py-5">

  <!-- Loading Blog -->
  @if (loadingBlog()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }

  <!-- Blog Error -->
  @if (blogError()) {
    <div class="alert alert-danger" role="alert">
      {{ blogError() }}
    </div>
  }

  <!-- Blog Content -->
  @if (blog() && !loadingBlog()) {
    <article class="blog-detail">

      <!-- Header -->
      <header class="blog-header mb-4">
        <h1 class="blog-title display-4 fw-bold mb-3">
          {{ blog()?.title }}
        </h1>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="d-flex align-items-center">
            <div class="avatar-circle me-3">
              <mat-icon>person</mat-icon>
            </div>
            <div>
              <p class="mb-0 fw-semibold">{{ blog()?.author?.username }}</p>
              <small class="text-muted">
                {{ blog()?.createdAt | date: 'MMM dd, yyyy' }}
              </small>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">{{ blog()?.likeCount }}</span>
            <button
              mat-icon-button
              [color]="isLiked() ? 'accent' : 'primary'"
              (click)="likeBlog()">
              <mat-icon>
                {{ isLiked() ? 'favorite' : 'favorite_border' }}
              </mat-icon>
            </button>

            <span class="text-muted small">{{ blog()?.commentCount }}</span>
            <mat-icon class="text-muted">comment</mat-icon>

            <button
              mat-icon-button
              color="warn"
              (click)="openReportDialog()">
              <mat-icon>flag</mat-icon>
            </button>
          </div>
        </div>
      </header>

      <mat-divider class="mb-4"></mat-divider>

      <!-- Media -->
      @if (mediaList().length > 0) {
        <section class="mb-4">
          <mat-card>
            <mat-card-content class="p-0">

              @if (isSelectedVideo()) {
                <video
                  [src]="selectedMediaUrl()!"
                  class="img-fluid rounded w-100"
                  controls>
                </video>
              } @else {
                <img
                  [src]="selectedMediaUrl()!"
                  class="img-fluid rounded w-100"
                  [alt]="blog()?.title">
              }

              @if (mediaList().length > 1) {
                <div class="p-2 d-flex gap-2">
                  @for (m of mediaList(); track $index; let i = $index) {
                    <button
                      class="thumb-btn"
                      [class.active]="i === selectedMediaIndex()"
                      (click)="selectMedia(i)">
                      <img [src]="m" class="thumb-img">
                    </button>
                  }
                </div>
              }

            </mat-card-content>
          </mat-card>
        </section>
      }

      <!-- Content -->
      <mat-card class="mb-4">
        <mat-card-content>
          <div [innerHTML]="blog()?.content"></div>
        </mat-card-content>
      </mat-card>

      <!-- Owner Actions -->
      @if (canEditBlog() || canDeleteBlog()) {
        <div class="d-flex gap-2 mb-4">
          @if (canEditBlog()) {
            <button mat-stroked-button (click)="editBlog()">
              <mat-icon>edit</mat-icon>
            </button>
          }
          @if (canDeleteBlog()) {
            <button mat-stroked-button color="warn" (click)="deleteBlog()">
              <mat-icon>delete</mat-icon>
            </button>
          }
        </div>
      }

      <mat-divider class="mb-4"></mat-divider>

      <!-- Add Comment -->
      <mat-card class="mb-4">
        <mat-card-content>
          <textarea
            class="form-control"
            rows="2"
            placeholder="Write a comment..."
            [ngModel]="commentText()"
            (ngModelChange)="commentText.set($event)"
            [disabled]="postingComment()">
          </textarea>

          <button
            mat-stroked-button
            color="primary"
            class="mt-2"
            (click)="postComment()"
            [disabled]="!commentText().trim() || postingComment()">
            {{ postingComment() ? 'Posting...' : 'Post Comment' }}
          </button>
        </mat-card-content>
      </mat-card>

      <!-- Comments Error -->
      @if (commentsError()) {
        <div class="alert alert-danger">
          {{ commentsError() }}
        </div>
      }

      <!-- Loading Comments -->
      @if (loadingComments()) {
        <div class="text-center py-3">
          <div class="spinner-border text-primary"></div>
        </div>
      }

      <!-- No Comments -->
      @if (!loadingComments() && comments().length === 0) {
        <div class="text-center text-muted py-4">
          <mat-icon>chat_bubble_outline</mat-icon>
          <p>No comments yet.</p>
        </div>
      }

      <!-- Comments List -->
      @for (comment of comments(); track comment.id) {
        <div class="border rounded p-3 mb-3">
          <div class="d-flex justify-content-between">
            <strong>{{ comment.author.username }}</strong>
            @if (canDeleteComment(comment)) {
              <button
                mat-icon-button
                color="warn"
                (click)="deleteComment(comment.id)">
                <mat-icon fontSize="14px">delete</mat-icon>
              </button>
            }
          </div>
          <p class="mb-1">{{ comment.content }}</p>
          <small class="text-muted">
            {{ comment.createdAt | date: 'MMM dd, HH:mm' }}
          </small>
        </div>
      }

    </article>
  }

</div>
